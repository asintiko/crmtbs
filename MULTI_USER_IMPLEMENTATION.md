# Реализация много пользовательского режима

## Выполненные изменения

### 1. ✅ Helper функция для получения userId из токена
**Файл:** `electron/main.ts`

Добавлена функция `getUserIdFromToken()`, которая:
- Получает токен сессии
- Проверяет валидность сессии
- Возвращает `userId` или `null`
- Логирует операции для отладки

### 2. ✅ Обновлены все IPC handlers
**Файл:** `electron/main.ts`

Все IPC handlers теперь:
- Принимают токен сессии как параметр
- Используют `getUserIdFromToken()` для получения `userId`
- Передают `userId` во все методы БД
- Проверяют авторизацию перед выполнением операций
- Логируют операции для отладки

**Обновленные handlers:**
- `auth:login`, `auth:logout`, `auth:getCurrentUser`, `auth:checkSession`
- `users:list`, `users:create`, `users:update`, `users:delete` (только для admin)
- `products:list`, `products:create`, `products:update`, `products:delete`
- `operations:list`, `operations:create`, `operations:delete`
- `dashboard:get`
- `reservations:list`, `reservations:update`
- `reminders:list`, `reminders:create`, `reminders:update`
- `sync:pull`, `sync:push`, `sync:getGoogleDriveConfig`, `sync:saveGoogleDriveConfig`

### 3. ✅ Обновлен preload.ts
**Файл:** `electron/preload.ts`

Добавлена функция `getToken()` для получения токена из localStorage.

Все API методы теперь:
- Автоматически получают токен из localStorage
- Передают токен в IPC handlers
- Обрабатывают ошибки авторизации

### 4. ✅ Обновлен startReminderLoop
**Файл:** `electron/main.ts`

Теперь проверяет напоминания для всех пользователей:
- Итерируется по всем пользователям в БД
- Проверяет напоминания для каждого пользователя отдельно
- Показывает уведомления с правильным контекстом
- Логирует операции

### 5. ✅ Добавлено логирование
**Файлы:** `electron/main.ts`

Добавлено логирование для отладки:
- Получение userId из токена
- Вход/выход пользователей
- Операции с продуктами, операциями и другими сущностями
- Показ напоминаний

Логи отправляются на сервер отладки: `http://127.0.0.1:7242/ingest/d0d7972b-8c29-47b4-9fc7-6bb593f6abb2`

## Как работает много пользовательский режим

1. **Авторизация:**
   - Пользователь входит через `api.login()`
   - Токен сессии сохраняется в `localStorage` под ключом `session_token`
   - Токен используется для всех последующих запросов

2. **Запросы к БД:**
   - Каждый IPC handler получает токен из preload
   - Токен проверяется через `getUserIdFromToken()`
   - `userId` передается во все методы БД
   - БД фильтрует данные по `user_id`

3. **Изоляция данных:**
   - Каждый пользователь видит только свои данные
   - Все операции привязаны к `user_id`
   - Невозможно получить доступ к данным другого пользователя

4. **Права доступа:**
   - Обычные пользователи могут работать только со своими данными
   - Администраторы могут управлять пользователями (через проверку `user.role === 'admin'`)

## Тестирование

### Шаги для проверки:

1. **Создайте несколько пользователей:**
   - Войдите как admin
   - Создайте 2-3 тестовых пользователя через Settings → Users

2. **Проверьте изоляцию данных:**
   - Войдите как первый пользователь
   - Создайте несколько продуктов
   - Выйдите и войдите как второй пользователь
   - Убедитесь, что продукты первого пользователя не видны

3. **Проверьте операции:**
   - Создайте операции для разных пользователей
   - Убедитесь, что каждый пользователь видит только свои операции

4. **Проверьте напоминания:**
   - Создайте напоминания для разных пользователей
   - Убедитесь, что уведомления показываются правильному пользователю

5. **Проверьте логи:**
   - Откройте файл `.cursor/debug.log`
   - Проверьте, что все операции логируются с правильным `userId`

## Важные замечания

1. **Токен сессии:** Токен хранится в `localStorage`, что безопасно для Electron приложения
2. **Истечение сессии:** Сессии истекают через 30 дней (настраивается в `createSession()`)
3. **Ошибки авторизации:** Если токен невалиден, все запросы вернут ошибку "Не авторизован"
4. **Администраторы:** Только пользователи с `role === 'admin'` могут управлять другими пользователями

## Дополнительные функции (реализовано)

1. ✅ **Автоматическое обновление токена при истечении**
   - Токен автоматически обновляется каждые 24 часа
   - Реализовано в `AuthProvider.tsx` через `useEffect` с интервалом
   - Использует метод `refreshSession` для продления срока действия

2. ✅ **Возможность смены пользователя без перезапуска**
   - Добавлена функция `switchUser` в `AuthProvider`
   - Кнопка "Сменить пользователя" в настройках
   - При смене пользователя происходит выход и перезагрузка страницы

3. ✅ **Логирование всех операций в таблицу audit_log**
   - Создана таблица `audit_log` в БД
   - Логируются операции: создание/обновление/удаление продуктов и операций
   - Логируются входы/выходы пользователей
   - Сохраняется информация: userId, actionType, entityType, entityId, details, ipAddress, userAgent

4. ✅ **Ограничения на количество одновременных сессий**
   - По умолчанию максимум 5 активных сессий на пользователя
   - При превышении лимита удаляется самая старая сессия
   - Реализовано в методе `createSession` в `database.ts`

5. ✅ **Автоматическая проверка обновлений через GitHub релизы**
   - Проверка обновлений при старте приложения (через 30 секунд)
   - Автоматическая проверка каждые 6 часов
   - Уведомления о доступных обновлениях
   - Реализовано в `main.ts` через `checkForUpdates`

## Сборка и деплой

### Сборка Windows exe:
```bash
npm run build:win
```

### Деплой на сервер:
Используйте скрипты `deploy.sh` (Linux/Mac) или `deploy.ps1` (Windows):
```bash
# Linux/Mac
./deploy.sh

# Windows PowerShell
.\deploy.ps1
```

Скрипты автоматически:
1. Собирают приложение
2. Находят собранный exe файл
3. Загружают его на сервер 144.31.17.123:1122 в `/tmp/inventory-desktop.exe`

**Примечание:** Для деплоя требуется настроенный SSH доступ к серверу.

